import{__awaiter as t}from"./_virtual/_tslib.js";import e from"./ws.js";import{encrypt as i,decrypt as s}from"./encryption.js";class r extends e{constructor(t,e,i){super(t,e,i&&{passphrase:null==i?void 0:i.passphrase}),(null==i?void 0:i.ttl)&&(this.ttl=null==i?void 0:i.ttl)}setItem(e,s,r){return t(this,void 0,void 0,(function*(){var t;if(!e)throw new Error("No name passed!");if(!s)throw new Error("No value passed!");if(this.passphrase&&!this.symKey)throw new Error("Call init() first!");const o=(null==r?void 0:r.ttl)||this.ttl,n=this.symKey?yield i(this.symKey,JSON.stringify(s)):s,l=yield this.request("POST",`/cache/${this.id}/${e}`,{value:n,ttl:o},null===(t=null==this?void 0:this.metadata)||void 0===t?void 0:t.keyVersion);return{expiresAt:null==l?void 0:l.expiresAt}}))}setItems(e){return t(this,void 0,void 0,(function*(){var t,s;if(!e||0===Object.keys(e).length)throw new Error("No items passed!");if(this.passphrase&&!this.symKey)throw new Error("Call init() first!");for(const t of Object.keys(e)){const r=this.symKey?yield i(this.symKey,JSON.stringify(e[t].value)):e[t].value;e[t].value=r,(s=e[t]).ttl||(s.ttl=this.ttl)}const r=yield this.request("POST",`/cache/${this.id}`,e,null===(t=null==this?void 0:this.metadata)||void 0===t?void 0:t.keyVersion);return Object.keys(r).reduce(((t,e)=>{var i,s;return t[e]={expiresAt:null!==(s=null===(i=r[e])||void 0===i?void 0:i.expiresAt)&&void 0!==s?s:0},t}),{})}))}getItem(e){return t(this,void 0,void 0,(function*(){var t;if(!e)throw new Error("No name passed!");if(this.passphrase&&!this.symKey)throw new Error("Call init() first!");const i=yield this.request("GET",`/cache/${this.id}/${e}`,void 0,null===(t=null==this?void 0:this.metadata)||void 0===t?void 0:t.keyVersion),r=null==i?void 0:i.value;if(!r)return;return{value:this.symKey?JSON.parse(yield s(this.symKey,r)):r,expiresAt:i.expiresAt}}))}getItems(e){return t(this,void 0,void 0,(function*(){var t;if(!e||0===e.length)throw new Error("No names passed!");if(this.passphrase&&!this.symKey)throw new Error("Call init() first!");const i=yield this.request("POST",`/cache-query/${this.id}`,e,null===(t=null==this?void 0:this.metadata)||void 0===t?void 0:t.keyVersion);if(0===Object.keys(i).length)return;const r={};for(const t of Object.keys(i)){const e=i[t],o=null==e?void 0:e.value;if(!o)continue;const n=this.symKey?JSON.parse(yield s(this.symKey,o)):o;r[t]={value:n,expiresAt:e.expiresAt}}return r}))}getAllItems(e){return t(this,void 0,void 0,(function*(){var t;if(this.passphrase&&!this.symKey)throw new Error("Call init() first!");const i=yield this.request("GET",`/cache/${this.id}${(null==e?void 0:e.prefix)?`?prefix=${null==e?void 0:e.prefix}`:""}`,void 0,null===(t=null==this?void 0:this.metadata)||void 0===t?void 0:t.keyVersion);if(0===Object.keys(i).length)return;const r={};for(const t of Object.keys(i)){const e=i[t],o=null==e?void 0:e.value;if(!o)continue;const n=this.symKey?JSON.parse(yield s(this.symKey,o)):o;r[t]={value:n,expiresAt:e.expiresAt}}return r}))}getAllKeys(e){return t(this,void 0,void 0,(function*(){return yield this.request("GET",`/cache-keys/${this.id}${(null==e?void 0:e.prefix)?`?prefix=${null==e?void 0:e.prefix}`:""}`)}))}removeItem(e){return t(this,void 0,void 0,(function*(){if(!e)throw new Error("No name passed!");yield this.request("DELETE",`/cache/${this.id}/${e}`)}))}removeItems(e){return t(this,void 0,void 0,(function*(){if(!e||0===e.length)throw new Error("No names passed!");yield this.request("DELETE",`/cache/${this.id}`,e)}))}clear(){return t(this,void 0,void 0,(function*(){yield this.request("DELETE",`/cache/${this.id}`)}))}}export{r as default};
