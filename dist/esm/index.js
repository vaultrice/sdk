import{__awaiter as e}from"./_virtual/_tslib.js";import i from"./ws.js";import{encrypt as t,decrypt as s}from"./encryption.js";class r extends i{constructor(e,i,t){super(e,i,t&&{passphrase:null==t?void 0:t.passphrase}),(null==t?void 0:t.ttl)&&(this.ttl=null==t?void 0:t.ttl)}setItem(i,s,r){return e(this,void 0,void 0,(function*(){var e;if(!i)throw new Error("No name passed!");if(!s)throw new Error("No value passed!");if(this.passphrase&&!this.symKey)throw new Error("Call getEncryptionSettings() first!");const n=(null==r?void 0:r.ttl)||this.ttl,o=this.symKey?yield t(this.symKey,JSON.stringify(s)):s,l=yield this.request("POST",`/cache/${this.class}/${this.id}/${i}`,{value:o,ttl:n});return{expiresAt:null==l?void 0:l.expiresAt,keyVersion:null!==(e=null==l?void 0:l.keyVersion)&&void 0!==e?e:void 0}}))}setItems(i){return e(this,void 0,void 0,(function*(){var e;if(!i||0===Object.keys(i).length)throw new Error("No items passed!");if(this.passphrase&&!this.symKey)throw new Error("Call getEncryptionSettings() first!");for(const s of Object.keys(i)){const r=this.symKey?yield t(this.symKey,JSON.stringify(i[s].value)):i[s].value;i[s].value=r,(e=i[s]).ttl||(e.ttl=this.ttl)}const s=yield this.request("POST",`/cache/${this.class}/${this.id}`,i);return Object.keys(s).reduce(((e,i)=>{var t,r,n,o;return e[i]={expiresAt:null!==(r=null===(t=s[i])||void 0===t?void 0:t.expiresAt)&&void 0!==r?r:0,keyVersion:null!==(o=null===(n=s[i])||void 0===n?void 0:n.keyVersion)&&void 0!==o?o:void 0},e}),{})}))}getItem(i){return e(this,void 0,void 0,(function*(){var e;if(!i)throw new Error("No name passed!");if(this.passphrase&&!this.symKey)throw new Error("Call getEncryptionSettings() first!");const t=yield this.request("GET",`/cache/${this.class}/${this.id}/${i}`),r=null==t?void 0:t.value;if(!r)return;const n=yield this.getSymKeyForKeyVersion(t.keyVersion),o=n?JSON.parse(yield s(n,r)):r;return(null==t?void 0:t.keyVersion)>-1&&t.keyVersion!==(null===(e=this.encryptionSettings)||void 0===e?void 0:e.keyVersion)&&this.logger.log("warn",`Item "${i}" has an old encryption and can be updated by storing it again.`),{value:o,expiresAt:t.expiresAt,keyVersion:t.keyVersion}}))}getItems(i){return e(this,void 0,void 0,(function*(){var e;if(!i||0===i.length)throw new Error("No names passed!");if(this.passphrase&&!this.symKey)throw new Error("Call getEncryptionSettings() first!");const t=yield this.request("POST",`/cache-query/${this.class}/${this.id}`,i);if(0===Object.keys(t).length)return;const r={};for(const i of Object.keys(t)){const n=t[i],o=null==n?void 0:n.value;if(!o)continue;const l=yield this.getSymKeyForKeyVersion(n.keyVersion),h=l?JSON.parse(yield s(l,o)):o;(null==n?void 0:n.keyVersion)>-1&&n.keyVersion!==(null===(e=this.encryptionSettings)||void 0===e?void 0:e.keyVersion)&&this.logger.log("warn",`Item "${i}" has an old encryption and can be updated by storing it again.`),r[i]={value:h,expiresAt:n.expiresAt,keyVersion:n.keyVersion}}return r}))}getAllItems(i){return e(this,void 0,void 0,(function*(){var e;if(this.passphrase&&!this.symKey)throw new Error("Call getEncryptionSettings() first!");const t=yield this.request("GET",`/cache/${this.class}/${this.id}${(null==i?void 0:i.prefix)?`?prefix=${null==i?void 0:i.prefix}`:""}`);if(0===Object.keys(t).length)return;const r={};for(const i of Object.keys(t)){const n=t[i],o=null==n?void 0:n.value;if(!o)continue;const l=yield this.getSymKeyForKeyVersion(n.keyVersion),h=l?JSON.parse(yield s(l,o)):o;r[i]={value:h,expiresAt:n.expiresAt,keyVersion:null!==(e=n.keyVersion)&&void 0!==e?e:void 0}}return r}))}getAllKeys(i){return e(this,void 0,void 0,(function*(){return yield this.request("GET",`/cache-keys/${this.class}/${this.id}${(null==i?void 0:i.prefix)?`?prefix=${null==i?void 0:i.prefix}`:""}`)}))}removeItem(i){return e(this,void 0,void 0,(function*(){if(!i)throw new Error("No name passed!");yield this.request("DELETE",`/cache/${this.class}/${this.id}/${i}`)}))}removeItems(i){return e(this,void 0,void 0,(function*(){if(!i||0===i.length)throw new Error("No names passed!");yield this.request("DELETE",`/cache/${this.class}/${this.id}`,i)}))}clear(){return e(this,void 0,void 0,(function*(){yield this.request("DELETE",`/cache/${this.class}/${this.id}`)}))}}export{r as default};
