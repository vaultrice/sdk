import{__awaiter as t}from"./_virtual/_tslib.js";import s from"./ws.js";import{encrypt as e,decrypt as i}from"./encryption.js";class r extends s{constructor(t,s,e){super(t,s,e&&{passphrase:null==e?void 0:e.passphrase}),(null==e?void 0:e.ttl)&&(this.ttl=null==e?void 0:e.ttl)}setItem(s,i,r){return t(this,void 0,void 0,(function*(){if(!s)throw new Error("No name passed!");if(!i)throw new Error("No value passed!");if(this.passphrase&&!this.symKey)throw new Error("Call init() first!");const t=(null==r?void 0:r.ttl)||this.ttl,o=this.symKey?yield e(this.symKey,JSON.stringify(i)):i,n=yield this.request("POST",`/cache/${this.class}/${this.id}/${s}`,{value:o,ttl:t});return{expiresAt:null==n?void 0:n.expiresAt}}))}setItems(s){return t(this,void 0,void 0,(function*(){var t;if(!s||0===Object.keys(s).length)throw new Error("No items passed!");if(this.passphrase&&!this.symKey)throw new Error("Call init() first!");for(const i of Object.keys(s)){const r=this.symKey?yield e(this.symKey,JSON.stringify(s[i].value)):s[i].value;s[i].value=r,(t=s[i]).ttl||(t.ttl=this.ttl)}const i=yield this.request("POST",`/cache/${this.class}/${this.id}`,s);return Object.keys(i).reduce(((t,s)=>{var e,r;return t[s]={expiresAt:null!==(r=null===(e=i[s])||void 0===e?void 0:e.expiresAt)&&void 0!==r?r:0},t}),{})}))}getItem(s){return t(this,void 0,void 0,(function*(){if(!s)throw new Error("No name passed!");if(this.passphrase&&!this.symKey)throw new Error("Call init() first!");const t=yield this.request("GET",`/cache/${this.class}/${this.id}/${s}`),e=null==t?void 0:t.value;if(!e)return;return{value:this.symKey?JSON.parse(yield i(this.symKey,e)):e,expiresAt:t.expiresAt}}))}getItems(s){return t(this,void 0,void 0,(function*(){if(!s||0===s.length)throw new Error("No names passed!");if(this.passphrase&&!this.symKey)throw new Error("Call init() first!");const t=yield this.request("POST",`/cache-query/${this.class}/${this.id}`,s);if(0===Object.keys(t).length)return;const e={};for(const s of Object.keys(t)){const r=t[s],o=null==r?void 0:r.value;if(!o)continue;const n=this.symKey?JSON.parse(yield i(this.symKey,o)):o;e[s]={value:n,expiresAt:r.expiresAt}}return e}))}getAllItems(s){return t(this,void 0,void 0,(function*(){if(this.passphrase&&!this.symKey)throw new Error("Call init() first!");const t=yield this.request("GET",`/cache/${this.class}/${this.id}${(null==s?void 0:s.prefix)?`?prefix=${null==s?void 0:s.prefix}`:""}`);if(0===Object.keys(t).length)return;const e={};for(const s of Object.keys(t)){const r=t[s],o=null==r?void 0:r.value;if(!o)continue;const n=this.symKey?JSON.parse(yield i(this.symKey,o)):o;e[s]={value:n,expiresAt:r.expiresAt}}return e}))}getAllKeys(s){return t(this,void 0,void 0,(function*(){return yield this.request("GET",`/cache-keys/${this.class}/${this.id}${(null==s?void 0:s.prefix)?`?prefix=${null==s?void 0:s.prefix}`:""}`)}))}removeItem(s){return t(this,void 0,void 0,(function*(){if(!s)throw new Error("No name passed!");yield this.request("DELETE",`/cache/${this.class}/${this.id}/${s}`)}))}removeItems(s){return t(this,void 0,void 0,(function*(){if(!s||0===s.length)throw new Error("No names passed!");yield this.request("DELETE",`/cache/${this.class}/${this.id}`,s)}))}clear(){return t(this,void 0,void 0,(function*(){yield this.request("DELETE",`/cache/${this.class}/${this.id}`)}))}}export{r as default};
