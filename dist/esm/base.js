import{__awaiter as t}from"./_virtual/_tslib.js";import{setLocalId as i,getLocalId as s}from"./local.js";import{deriveSymmetricKey as e}from"./encryption.js";import r from"./uuidv4.js";const o="_undefined_";class n{constructor(t,e=function(){return s()||`${r()}-${r()}`}(),n={class:o}){if(this.id=e,this.class=o,!t||"object"!=typeof t||"string"!=typeof t.apiKey||"string"!=typeof t.apiSecret||"string"!=typeof t.projectId)throw new Error("Invalid credentials!");i(this.id),this.credentials=t,this.class=n.class||o,n.passphrase&&(this.passphrase=n.passphrase),n.signedId&&(this.signedId=n.signedId),this.signedId&&(this.idSignatureKeyVersion=n.idSignatureKeyVersion||0)}init(){return t(this,void 0,void 0,(function*(){if(!this.passphrase)throw new Error("No passphrase passed! This function is only allowed with e2e encryption!");const t=yield this.request("GET",`/cache-meta/${this.id}`);this.metadata={salt:Uint8Array.from(atob(null==t?void 0:t.salt),(t=>t.charCodeAt(0))),keyVersion:null==t?void 0:t.keyVersion},this.symKey=yield e(this.passphrase,this.id,this.metadata.salt)}))}request(i,s,e){return t(this,void 0,void 0,(function*(){var t;const r="string"==typeof e,o={Authorization:`Basic ${btoa(`${this.credentials.apiKey}:${this.credentials.apiSecret}`)}`},a=null===(t=null==this?void 0:this.metadata)||void 0===t?void 0:t.keyVersion;void 0!==a&&a>-1&&(o["X-Enc-KV"]=a.toString()),this.signedId&&void 0!==this.idSignatureKeyVersion&&(o["X-Id-Sig"]=this.signedId,o["X-Id-Sig-KV"]=this.idSignatureKeyVersion.toString()),e&&(o["Content-Type"]=r?"text/plain":"application/json");const d=yield fetch(`${n.basePath}/project/${this.credentials.projectId}/${this.class}${s}`,{method:i,headers:o,body:r?e:JSON.stringify(e)}),h=d.headers.get("content-type");let l;if(h&&(0===h.indexOf("text/plain")?l=yield d.text():0===h.indexOf("application/json")&&(l=yield d.json())),!d.ok){if("string"==typeof l)throw new Error(l);if(l)throw new Error(l.message)}return l}))}}n.basePath="http://localhost:5173";export{n as default};
