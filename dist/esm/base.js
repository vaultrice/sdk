import{__awaiter as t}from"./_virtual/_tslib.js";import{setLocalId as e,getLocalId as i}from"./local.js";import{deriveSymmetricKey as s}from"./encryption.js";import o from"./uuidv4.js";class r{constructor(t,s=function(){return i()||("undefined"!=typeof crypto&&crypto.randomUUID?`${crypto.randomUUID()}-${crypto.randomUUID()}`:`${o()}-${o()}`)}(),r){if(this.id=s,!t||"object"!=typeof t||"string"!=typeof t.apiKey||"string"!=typeof t.apiSecret||"string"!=typeof t.projectId)throw new Error("Invalid credentials!");e(this.id),this.credentials=t,(null==r?void 0:r.passphrase)&&(this.passphrase=null==r?void 0:r.passphrase)}init(){return t(this,void 0,void 0,(function*(){if(!this.passphrase)throw new Error("No passphrase passed! This function is only allowed with e2e encryption!");const t=yield this.request("GET",`/cache-meta/${this.id}`);this.metadata={salt:Uint8Array.from(atob(null==t?void 0:t.salt),(t=>t.charCodeAt(0))),keyVersion:null==t?void 0:t.keyVersion},this.symKey=yield s(this.passphrase,this.id,this.metadata.salt)}))}request(e,i,s,o){return t(this,void 0,void 0,(function*(){const t="string"==typeof s,n={Authorization:`Basic ${btoa(`${this.credentials.apiKey}:${this.credentials.apiSecret}`)}`};void 0!==o&&o>-1&&(n["X-Enc-KV"]=o.toString()),s&&(n["Content-Type"]=t?"text/plain":"application/json");const a=yield fetch(`${r.basePath}/project/${this.credentials.projectId}${i}`,{method:e,headers:n,body:t?s:JSON.stringify(s)}),p=a.headers.get("content-type");let d;if(p&&(0===p.indexOf("text/plain")?d=yield a.text():0===p.indexOf("application/json")&&(d=yield a.json())),!a.ok){if("string"==typeof d)throw new Error(d);if(d)throw new Error(d.message)}return d}))}}r.basePath="http://localhost:5173";export{r as default};
