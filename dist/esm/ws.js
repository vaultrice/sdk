import{__awaiter as e}from"./_virtual/_tslib.js";import t from"./base.js";class n extends t{constructor(e,t,n){super(e,t,n&&{passphrase:null==n?void 0:n.passphrase})}send(t){return e(this,arguments,void 0,(function*(e,t={transport:"ws"}){var n,s,o;if(this.passphrase&&!this.symKey)throw new Error("Call init() first!");if("http"===t.transport)return void(yield this.request("POST",`/message/${this.id}`,e,null===(n=null==this?void 0:this.metadata)||void 0===n?void 0:n.keyVersion));const r=this.getWebSocket(),i={event:"message",payload:e};(null===(s=null==this?void 0:this.metadata)||void 0===s?void 0:s.keyVersion)&&(i.keyVersion=null===(o=null==this?void 0:this.metadata)||void 0===o?void 0:o.keyVersion),r.send(JSON.stringify(i))}))}on(e,t,n){const s=this.getWebSocket();if("error"===e){if("function"!=typeof t)throw new Error("No event handler defined!");const e=t;s.addEventListener("error",(t=>e(new Error(null==t?void 0:t.message))))}if("connect"===e){if("function"!=typeof t)throw new Error("No event handler defined!");const e=t;s.addEventListener("open",(()=>e()))}if("disconnect"===e){if("function"!=typeof t)throw new Error("No event handler defined!");const e=t;s.addEventListener("close",(()=>e()))}if("message"===e){if("function"!=typeof t)throw new Error("No event handler defined!");const e=t;s.addEventListener("message",(t=>{const n=JSON.parse(t.data);"message"===n.event&&e(n.payload)}))}if("setItem"===e)if(void 0===n){if("function"!=typeof t)throw new Error("No event handler defined!");const e=t;s.addEventListener("message",(t=>{const n=JSON.parse(t.data);"setItem"===n.event&&e(n.payload)}))}else{if("function"!=typeof n)throw new Error("No event handler defined!");const e=n,o=t;s.addEventListener("message",(t=>{const n=JSON.parse(t.data);"setItem"===n.event&&n.payload.prop===o&&e(n.payload)}))}if("removeItem"===e)if(void 0===n){if("function"!=typeof t)throw new Error("No event handler defined!");const e=t;s.addEventListener("message",(t=>{const n=JSON.parse(t.data);"removeItem"===n.event&&e(n.payload)}))}else{if("function"!=typeof n)throw new Error("No event handler defined!");const e=n,o=t;s.addEventListener("message",(t=>{const n=JSON.parse(t.data);"removeItem"===n.event&&n.payload.prop===o&&e(n.payload)}))}}disconnect(){this.ws&&(this.ws.close(),delete this.ws)}getWebSocket(){if(this.ws)return this.ws;const e=n.basePath.replace("http","ws"),t=this.ws=new WebSocket(`${e}/project/${this.credentials.projectId}/ws/${this.id}`,encodeURIComponent(`Basic ${btoa(`${this.credentials.apiKey}:${this.credentials.apiSecret}`)}`));return t.addEventListener("close",(()=>{delete this.ws})),t}}export{n as default};
