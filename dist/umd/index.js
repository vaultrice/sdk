var NonLocalStorage=function(){"use strict";function e(e,t,i,s){return new(i||(i=Promise))((function(r,n){function o(e){try{d(s.next(e))}catch(e){n(e)}}function a(e){try{d(s.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}d((s=s.apply(e,t||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;const t="NON_LOCAL_STORAGE_LOCAL_ID";function i(t,i){return e(this,arguments,void 0,(function*(e,t,i={algorithm:"AES-GCM"}){const s=new TextEncoder,r=crypto.getRandomValues(new Uint8Array(12)),n=yield crypto.subtle.encrypt({name:(null==i?void 0:i.algorithm)||"AES-GCM",iv:r},e,s.encode(t));return JSON.stringify({iv:btoa(String.fromCharCode(...r)),data:btoa(String.fromCharCode(...new Uint8Array(n)))})}))}function s(t,i){return e(this,arguments,void 0,(function*(e,t,i={algorithm:"AES-GCM"}){const s=JSON.parse(t),r=new TextDecoder,n=Uint8Array.from(atob(s.iv),(e=>e.charCodeAt(0))),o=Uint8Array.from(atob(s.data),(e=>e.charCodeAt(0))),a=yield crypto.subtle.decrypt({name:(null==i?void 0:i.algorithm)||"AES-GCM",iv:n},e,o);return r.decode(a)}))}let r;r="undefined"!=typeof crypto&&"function"==typeof crypto.randomUUID?()=>crypto.randomUUID():()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}));var n=r;function o(){const e="undefined"!=typeof window&&window.localStorage?window.localStorage.getItem(t):null;return e||`${n()}-${n()}`}const a="_undefined_";class d{constructor(e,i=o(),s={class:a}){if(this.id=i,this.class=a,!e||"object"!=typeof e||"string"!=typeof e.apiKey||"string"!=typeof e.apiSecret||"string"!=typeof e.projectId)throw new Error("Invalid credentials!");(e=>{"undefined"!=typeof window&&window.localStorage&&window.localStorage.setItem(t,e)})(this.id),this.credentials=e,this.class=s.class||a,s.passphrase&&(this.passphrase=s.passphrase),s.signedId&&(this.signedId=s.signedId),this.signedId&&(this.idSignatureKeyVersion=s.idSignatureKeyVersion||0)}init(){return e(this,void 0,void 0,(function*(){if(!this.passphrase)throw new Error("No passphrase passed! This function is only allowed with e2e encryption!");const t=yield this.request("GET",`/cache-meta/${this.id}`);this.metadata={salt:Uint8Array.from(atob(null==t?void 0:t.salt),(e=>e.charCodeAt(0))),keyVersion:null==t?void 0:t.keyVersion},this.symKey=yield function(t,i,s){return e(this,arguments,void 0,(function*(e,t,i,s=1e5,r={hash:"SHA-512",derivedKeyType:{name:"AES-GCM",length:256}}){const n=new TextEncoder,o=yield crypto.subtle.importKey("raw",n.encode(e+":"+t),"PBKDF2",!1,["deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:i,iterations:s,hash:(null==r?void 0:r.hash)||"SHA-512"},o,(null==r?void 0:r.derivedKeyType)||{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}))}(this.passphrase,this.id,this.metadata.salt)}))}request(t,i,s){return e(this,void 0,void 0,(function*(){var e;const r="string"==typeof s,n={Authorization:`Basic ${btoa(`${this.credentials.apiKey}:${this.credentials.apiSecret}`)}`},o=null===(e=null==this?void 0:this.metadata)||void 0===e?void 0:e.keyVersion;void 0!==o&&o>-1&&(n["X-Enc-KV"]=o.toString()),this.signedId&&void 0!==this.idSignatureKeyVersion&&(n["X-Id-Sig"]=this.signedId,n["X-Id-Sig-KV"]=this.idSignatureKeyVersion.toString()),s&&(n["Content-Type"]=r?"text/plain":"application/json");const a=yield fetch(`${d.basePath}/project/${this.credentials.projectId}/${this.class}${i}`,{method:t,headers:n,body:r?s:JSON.stringify(s)}),h=a.headers.get("content-type");let l;if(h&&(0===h.indexOf("text/plain")?l=yield a.text():0===h.indexOf("application/json")&&(l=yield a.json())),!a.ok){if("string"==typeof l)throw new Error(l);if(l)throw new Error(l.message)}return l}))}}d.basePath="http://localhost:5173";class h extends d{constructor(e,t,i){super(e,t,i&&{passphrase:null==i?void 0:i.passphrase}),this.errorHandlers=[]}send(t){return e(this,arguments,void 0,(function*(e,t={transport:"ws"}){var s,r;if(this.passphrase&&!this.symKey)throw new Error("Call init() first!");const n=this.symKey?yield i(this.symKey,JSON.stringify(e)):e;if("http"===t.transport)return void(yield this.request("POST",`/message/${this.id}`,n));const o=this.getWebSocket(),a={event:"message",payload:n};(null===(s=null==this?void 0:this.metadata)||void 0===s?void 0:s.keyVersion)>-1&&(a.keyVersion=null===(r=null==this?void 0:this.metadata)||void 0===r?void 0:r.keyVersion),this.signedId&&void 0!==this.idSignatureKeyVersion&&(a.signedId=this.signedId,a.idSignatureKeyVersion=this.idSignatureKeyVersion),o.send(JSON.stringify(a))}))}on(e,t,i){const r=this.getWebSocket();if("error"===e){if("function"!=typeof t)throw new Error("No event handler defined!");const e=t;this.errorHandlers.push(e),r.addEventListener("error",(t=>e(new Error(null==t?void 0:t.message))))}if("connect"===e){if("function"!=typeof t)throw new Error("No event handler defined!");const e=t;r.addEventListener("open",(()=>e()))}if("disconnect"===e){if("function"!=typeof t)throw new Error("No event handler defined!");const e=t;r.addEventListener("close",(()=>e()))}const n=(e,t,i=!1)=>{var r;if(void 0===e.keyVersion)return t(e.payload);if(e.keyVersion>-1){if(!this.passphrase)return this.errorHandlers.map((e=>e(new Error("Encrypted data, but no passhprase configured!"))));if(!this.symKey)return this.errorHandlers.map((e=>e(new Error("Encrypted data, but init() not called!"))));if(e.keyVersion!==(null===(r=null==this?void 0:this.metadata)||void 0===r?void 0:r.keyVersion))return this.errorHandlers.map((e=>e(new Error("Wrong keyVersion! Call init() again!"))));let n=e.payload.value;i&&(n=e.payload),s(this.symKey,n).then((s=>{i?e.payload=JSON.parse(s):e.payload.value=JSON.parse(s),t(e.payload)})).catch((e=>{this.errorHandlers.map((t=>t(e)))}))}};if("message"===e){if("function"!=typeof t)throw new Error("No event handler defined!");const e=t;r.addEventListener("message",(t=>{const i=JSON.parse(t.data);"message"===i.event&&n(i,e,!0)}))}if("setItem"===e)if(void 0===i){if("function"!=typeof t)throw new Error("No event handler defined!");const e=t;r.addEventListener("message",(t=>{const i=JSON.parse(t.data);"setItem"===i.event&&n(i,e)}))}else{if("function"!=typeof i)throw new Error("No event handler defined!");const e=i,s=t;r.addEventListener("message",(t=>{const i=JSON.parse(t.data);"setItem"===i.event&&i.payload.prop===s&&n(i,e)}))}if("removeItem"===e)if(void 0===i){if("function"!=typeof t)throw new Error("No event handler defined!");const e=t;r.addEventListener("message",(t=>{const i=JSON.parse(t.data);"removeItem"===i.event&&e(i.payload)}))}else{if("function"!=typeof i)throw new Error("No event handler defined!");const e=i,s=t;r.addEventListener("message",(t=>{const i=JSON.parse(t.data);"removeItem"===i.event&&i.payload.prop===s&&e(i.payload)}))}}disconnect(){this.ws&&(this.ws.close(),delete this.ws)}getWebSocket(){if(this.ws)return this.ws;const e=h.basePath.replace("http","ws"),t=this.ws=new WebSocket(`${e}/project/${this.credentials.projectId}/${this.class}/ws/${this.id}`,encodeURIComponent(`Basic ${btoa(`${this.credentials.apiKey}:${this.credentials.apiSecret}`)}`));return t.addEventListener("close",(()=>{delete this.ws})),t}}return class extends h{constructor(e,t,i){super(e,t,i&&{passphrase:null==i?void 0:i.passphrase}),(null==i?void 0:i.ttl)&&(this.ttl=null==i?void 0:i.ttl)}setItem(t,s,r){return e(this,void 0,void 0,(function*(){if(!t)throw new Error("No name passed!");if(!s)throw new Error("No value passed!");if(this.passphrase&&!this.symKey)throw new Error("Call init() first!");const e=(null==r?void 0:r.ttl)||this.ttl,n=this.symKey?yield i(this.symKey,JSON.stringify(s)):s,o=yield this.request("POST",`/cache/${this.id}/${t}`,{value:n,ttl:e});return{expiresAt:null==o?void 0:o.expiresAt}}))}setItems(t){return e(this,void 0,void 0,(function*(){var e;if(!t||0===Object.keys(t).length)throw new Error("No items passed!");if(this.passphrase&&!this.symKey)throw new Error("Call init() first!");for(const s of Object.keys(t)){const r=this.symKey?yield i(this.symKey,JSON.stringify(t[s].value)):t[s].value;t[s].value=r,(e=t[s]).ttl||(e.ttl=this.ttl)}const s=yield this.request("POST",`/cache/${this.id}`,t);return Object.keys(s).reduce(((e,t)=>{var i,r;return e[t]={expiresAt:null!==(r=null===(i=s[t])||void 0===i?void 0:i.expiresAt)&&void 0!==r?r:0},e}),{})}))}getItem(t){return e(this,void 0,void 0,(function*(){if(!t)throw new Error("No name passed!");if(this.passphrase&&!this.symKey)throw new Error("Call init() first!");const e=yield this.request("GET",`/cache/${this.id}/${t}`),i=null==e?void 0:e.value;if(!i)return;return{value:this.symKey?JSON.parse(yield s(this.symKey,i)):i,expiresAt:e.expiresAt}}))}getItems(t){return e(this,void 0,void 0,(function*(){if(!t||0===t.length)throw new Error("No names passed!");if(this.passphrase&&!this.symKey)throw new Error("Call init() first!");const e=yield this.request("POST",`/cache-query/${this.id}`,t);if(0===Object.keys(e).length)return;const i={};for(const t of Object.keys(e)){const r=e[t],n=null==r?void 0:r.value;if(!n)continue;const o=this.symKey?JSON.parse(yield s(this.symKey,n)):n;i[t]={value:o,expiresAt:r.expiresAt}}return i}))}getAllItems(t){return e(this,void 0,void 0,(function*(){if(this.passphrase&&!this.symKey)throw new Error("Call init() first!");const e=yield this.request("GET",`/cache/${this.id}${(null==t?void 0:t.prefix)?`?prefix=${null==t?void 0:t.prefix}`:""}`);if(0===Object.keys(e).length)return;const i={};for(const t of Object.keys(e)){const r=e[t],n=null==r?void 0:r.value;if(!n)continue;const o=this.symKey?JSON.parse(yield s(this.symKey,n)):n;i[t]={value:o,expiresAt:r.expiresAt}}return i}))}getAllKeys(t){return e(this,void 0,void 0,(function*(){return yield this.request("GET",`/cache-keys/${this.id}${(null==t?void 0:t.prefix)?`?prefix=${null==t?void 0:t.prefix}`:""}`)}))}removeItem(t){return e(this,void 0,void 0,(function*(){if(!t)throw new Error("No name passed!");yield this.request("DELETE",`/cache/${this.id}/${t}`)}))}removeItems(t){return e(this,void 0,void 0,(function*(){if(!t||0===t.length)throw new Error("No names passed!");yield this.request("DELETE",`/cache/${this.id}`,t)}))}clear(){return e(this,void 0,void 0,(function*(){yield this.request("DELETE",`/cache/${this.id}`)}))}}}();
