"use strict";var t=require("./_virtual/_tslib.js"),e=require("./local.js"),i=require("./encryption.js"),n=require("./uuidv4.js"),r=require("./logger.js"),s=require("./decodeJwt.js"),o=require("./symbols.js");function a(){const t=e.getLocalId();return t||`${n()}-${n()}`}const d="_undefined_";class c{constructor(n,s={id:a(),class:d,autoUpdateOldEncryptedValues:!0,logLevel:"warn"}){this.class=d;let c={class:d,logLevel:"warn"};if("string"==typeof s?(this.id=s,c={class:d,logLevel:"warn"}):(this.id=s.id||a(),c=s),this.logger=r.default(c.logLevel),!n||"object"!=typeof n||"string"!=typeof n.apiKey||"string"!=typeof n.apiSecret||"string"!=typeof n.projectId)throw new Error("Invalid credentials!");if(e.setLocalId(this.id),this[o.CREDENTIALS]=n,this.class=c.class||d,c.passphrase&&c.getEncryptionHandler)throw new Error("Either define a passphrase or a getEncryptionHandler, but not both!");c.getEncryptionHandler&&(this.getEncryptionHandler=c.getEncryptionHandler),c.passphrase&&(this.getEncryptionHandler=e=>t.__awaiter(this,void 0,void 0,(function*(){var t,n,r,s;const o=yield i.deriveSymmetricKey(c.passphrase,this.id,e.salt,c.keyDerivationOptions),a=(null===(n=null===(t=c.keyDerivationOptions)||void 0===t?void 0:t.derivedKeyType)||void 0===n?void 0:n.name)?{algorithm:null===(s=null===(r=c.keyDerivationOptions)||void 0===r?void 0:r.derivedKeyType)||void 0===s?void 0:s.name}:void 0;return{encrypt:t=>i.encrypt(o,t,a),decrypt:t=>i.decrypt(o,t,a)}}))),void 0===c.autoUpdateOldEncryptedValues&&(c.autoUpdateOldEncryptedValues=!0),this.autoUpdateOldEncryptedValues=c.autoUpdateOldEncryptedValues,c.idSignature&&(this.idSignature=c.idSignature),this.idSignature&&(this.idSignatureKeyVersion=c.idSignatureKeyVersion||0),this.isGettingAccessToken=this.getAccessToken(),this.isGettingAccessToken.then((()=>{this.isGettingAccessToken=void 0}),(()=>{this.isGettingAccessToken=void 0}))}getAccessToken(){return t.__awaiter(this,void 0,void 0,(function*(){const t=yield this.request("GET","/auth/token"),e=s(t);this.accessToken=t;const i=e.payload.exp-Date.now();setTimeout((()=>this.getAccessToken()),i-12e4)}))}getEncryptionHandlerForKeyVersion(e){return t.__awaiter(this,void 0,void 0,(function*(){var t,i,n,r;if(e>-1&&(e!==(null===(t=this[o.ENCRYPTION_SETTINGS])||void 0===t?void 0:t.keyVersion)&&(this[o.PREVIOUS_ENCRYPTION_SETTINGS]&&0!==this[o.PREVIOUS_ENCRYPTION_SETTINGS].length||(yield this.getEncryptionSettings())),e!==(null===(i=this[o.ENCRYPTION_SETTINGS])||void 0===i?void 0:i.keyVersion))){if(!this[o.PREVIOUS_ENCRYPTION_SETTINGS]||0===this[o.PREVIOUS_ENCRYPTION_SETTINGS].length)throw new Error(`Wrong keyVersion! Found ${e} but you're using ${null===(n=this[o.ENCRYPTION_SETTINGS])||void 0===n?void 0:n.keyVersion}`);let t=this[o.PREVIOUS_ENCRYPTION_SETTINGS].find((t=>t.keyVersion===e));if(t||(yield this.getEncryptionSettings()),t=(this[o.PREVIOUS_ENCRYPTION_SETTINGS]||[]).find((t=>t.keyVersion===e)),!t)throw new Error(`Wrong keyVersion! Found ${e} but you're using ${null===(r=this[o.ENCRYPTION_SETTINGS])||void 0===r?void 0:r.keyVersion}`);if(!this.getEncryptionHandler)return;return this.getEncryptionHandler(t)}return this.encryptionHandler}))}handleEncryptionSettings(e){return t.__awaiter(this,void 0,void 0,(function*(){if(!this.getEncryptionHandler)throw new Error("No getEncryptionHandler defined!");this[o.ENCRYPTION_SETTINGS]=e.encryptionSettings,this[o.PREVIOUS_ENCRYPTION_SETTINGS]=e.previousEncryptionSettings,this.encryptionHandler=yield this.getEncryptionHandler(e.encryptionSettings)}))}prepareEncryptionSettings(t){var e,i,n;return{encryptionSettings:{salt:Uint8Array.from(atob(null===(e=null==t?void 0:t.encryptionSettings)||void 0===e?void 0:e.salt),(t=>t.charCodeAt(0))),keyVersion:null===(i=null==t?void 0:t.encryptionSettings)||void 0===i?void 0:i.keyVersion,createdAt:null===(n=null==t?void 0:t.encryptionSettings)||void 0===n?void 0:n.createdAt},previousEncryptionSettings:((null==t?void 0:t.previousEncryptionSettings)||[]).map((t=>({salt:Uint8Array.from(atob(null==t?void 0:t.salt),(t=>t.charCodeAt(0))),keyVersion:null==t?void 0:t.keyVersion,createdAt:null==t?void 0:t.createdAt})))}}getEncryptionSettings(){return t.__awaiter(this,arguments,void 0,(function*(t=16){if(!this.getEncryptionHandler)throw new Error("No passphrase and no getEncryptionHandler passed! This function is only allowed with e2e encryption!");const e=yield this.request("POST",`/cache-encryption/${this.class}/${this.id}`,{saltLength:t}),i=this.prepareEncryptionSettings(e);return yield this.handleEncryptionSettings(i),i}))}rotateEncryption(){return t.__awaiter(this,arguments,void 0,(function*(t=16){if(!this.getEncryptionHandler)throw new Error("No passphrase and no getEncryptionHandler passed! This function is only allowed with e2e encryption!");const e=yield this.request("POST",`/cache-encryption-rotate/${this.class}/${this.id}`,{saltLength:t}),i=this.prepareEncryptionSettings(e);return yield this.handleEncryptionSettings(i),i}))}request(e,i,n){return t.__awaiter(this,void 0,void 0,(function*(){var t;!this.accessToken&&this.isGettingAccessToken&&(yield this.isGettingAccessToken);const r={Authorization:this.accessToken?`Bearer ${this.accessToken}`:`Basic ${btoa(`${this[o.CREDENTIALS].apiKey}:${this[o.CREDENTIALS].apiSecret}`)}`},s="string"==typeof n,a=null===(t=this[o.ENCRYPTION_SETTINGS])||void 0===t?void 0:t.keyVersion;void 0!==a&&a>-1&&(r["X-Enc-KV"]=a.toString()),this.idSignature&&void 0!==this.idSignatureKeyVersion&&(r["X-Id-Sig"]=this.idSignature,r["X-Id-Sig-KV"]=this.idSignatureKeyVersion.toString()),n&&(r["Content-Type"]=s?"text/plain":"application/json");const d=yield fetch(`${c.basePath}/project/${this[o.CREDENTIALS].projectId}${i}`,{method:e,headers:r,body:n?s?n:JSON.stringify(n):void 0}),l=d.headers.get("content-type");let h;if(l)try{0===l.indexOf("text/plain")?h=yield d.text():0===l.indexOf("application/json")&&(h=yield d.json())}catch(t){h=`${d.status} - ${d.statusText}`}if(!d.ok){if("string"==typeof h)throw new Error(h);if(h)throw h;if(404!==d.status)throw new Error(`${d.status} - ${d.statusText}`)}return h}))}}c.basePath="https://api.vaultrice.app",module.exports=c;
