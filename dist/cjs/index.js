"use strict";var e=require("./_virtual/_tslib.js"),t=require("./ws.js"),s=require("./encryption.js");module.exports=class extends t{constructor(e,t,s){super(e,t,s&&{passphrase:null==s?void 0:s.passphrase}),(null==s?void 0:s.ttl)&&(this.ttl=null==s?void 0:s.ttl)}setItem(t,i,r){return e.__awaiter(this,void 0,void 0,(function*(){if(!t)throw new Error("No name passed!");if(!i)throw new Error("No value passed!");if(this.passphrase&&!this.symKey)throw new Error("Call init() first!");const e=(null==r?void 0:r.ttl)||this.ttl,n=this.symKey?yield s.encrypt(this.symKey,JSON.stringify(i)):i,o=yield this.request("POST",`/cache/${this.class}/${this.id}/${t}`,{value:n,ttl:e});return{expiresAt:null==o?void 0:o.expiresAt}}))}setItems(t){return e.__awaiter(this,void 0,void 0,(function*(){var e;if(!t||0===Object.keys(t).length)throw new Error("No items passed!");if(this.passphrase&&!this.symKey)throw new Error("Call init() first!");for(const i of Object.keys(t)){const r=this.symKey?yield s.encrypt(this.symKey,JSON.stringify(t[i].value)):t[i].value;t[i].value=r,(e=t[i]).ttl||(e.ttl=this.ttl)}const i=yield this.request("POST",`/cache/${this.class}/${this.id}`,t);return Object.keys(i).reduce(((e,t)=>{var s,r;return e[t]={expiresAt:null!==(r=null===(s=i[t])||void 0===s?void 0:s.expiresAt)&&void 0!==r?r:0},e}),{})}))}getItem(t){return e.__awaiter(this,void 0,void 0,(function*(){if(!t)throw new Error("No name passed!");if(this.passphrase&&!this.symKey)throw new Error("Call init() first!");const e=yield this.request("GET",`/cache/${this.class}/${this.id}/${t}`),i=null==e?void 0:e.value;if(!i)return;return{value:this.symKey?JSON.parse(yield s.decrypt(this.symKey,i)):i,expiresAt:e.expiresAt}}))}getItems(t){return e.__awaiter(this,void 0,void 0,(function*(){if(!t||0===t.length)throw new Error("No names passed!");if(this.passphrase&&!this.symKey)throw new Error("Call init() first!");const e=yield this.request("POST",`/cache-query/${this.class}/${this.id}`,t);if(0===Object.keys(e).length)return;const i={};for(const t of Object.keys(e)){const r=e[t],n=null==r?void 0:r.value;if(!n)continue;const o=this.symKey?JSON.parse(yield s.decrypt(this.symKey,n)):n;i[t]={value:o,expiresAt:r.expiresAt}}return i}))}getAllItems(t){return e.__awaiter(this,void 0,void 0,(function*(){if(this.passphrase&&!this.symKey)throw new Error("Call init() first!");const e=yield this.request("GET",`/cache/${this.class}/${this.id}${(null==t?void 0:t.prefix)?`?prefix=${null==t?void 0:t.prefix}`:""}`);if(0===Object.keys(e).length)return;const i={};for(const t of Object.keys(e)){const r=e[t],n=null==r?void 0:r.value;if(!n)continue;const o=this.symKey?JSON.parse(yield s.decrypt(this.symKey,n)):n;i[t]={value:o,expiresAt:r.expiresAt}}return i}))}getAllKeys(t){return e.__awaiter(this,void 0,void 0,(function*(){return yield this.request("GET",`/cache-keys/${this.class}/${this.id}${(null==t?void 0:t.prefix)?`?prefix=${null==t?void 0:t.prefix}`:""}`)}))}removeItem(t){return e.__awaiter(this,void 0,void 0,(function*(){if(!t)throw new Error("No name passed!");yield this.request("DELETE",`/cache/${this.class}/${this.id}/${t}`)}))}removeItems(t){return e.__awaiter(this,void 0,void 0,(function*(){if(!t||0===t.length)throw new Error("No names passed!");yield this.request("DELETE",`/cache/${this.class}/${this.id}`,t)}))}clear(){return e.__awaiter(this,void 0,void 0,(function*(){yield this.request("DELETE",`/cache/${this.class}/${this.id}`)}))}};
