"use strict";var e=require("./_virtual/_tslib.js"),t=require("./ws.js"),i=require("./encryption.js");module.exports=class extends t{constructor(e,t,i){super(e,t,i&&{passphrase:null==i?void 0:i.passphrase}),(null==i?void 0:i.ttl)&&(this.ttl=null==i?void 0:i.ttl)}setItem(t,s,r){return e.__awaiter(this,void 0,void 0,(function*(){var e;if(!t)throw new Error("No name passed!");if(!s)throw new Error("No value passed!");if(this.passphrase&&!this.symKey)throw new Error("Call getEncryptionSettings() first!");const n=(null==r?void 0:r.ttl)||this.ttl,o=this.symKey?yield i.encrypt(this.symKey,JSON.stringify(s)):s,l=yield this.request("POST",`/cache/${this.class}/${this.id}/${t}`,{value:o,ttl:n});return{expiresAt:null==l?void 0:l.expiresAt,keyVersion:null!==(e=null==l?void 0:l.keyVersion)&&void 0!==e?e:void 0}}))}setItems(t){return e.__awaiter(this,void 0,void 0,(function*(){var e;if(!t||0===Object.keys(t).length)throw new Error("No items passed!");if(this.passphrase&&!this.symKey)throw new Error("Call getEncryptionSettings() first!");for(const s of Object.keys(t)){const r=this.symKey?yield i.encrypt(this.symKey,JSON.stringify(t[s].value)):t[s].value;t[s].value=r,(e=t[s]).ttl||(e.ttl=this.ttl)}const s=yield this.request("POST",`/cache/${this.class}/${this.id}`,t);return Object.keys(s).reduce(((e,t)=>{var i,r,n,o;return e[t]={expiresAt:null!==(r=null===(i=s[t])||void 0===i?void 0:i.expiresAt)&&void 0!==r?r:0,keyVersion:null!==(o=null===(n=s[t])||void 0===n?void 0:n.keyVersion)&&void 0!==o?o:void 0},e}),{})}))}getItem(t){return e.__awaiter(this,void 0,void 0,(function*(){var e;if(!t)throw new Error("No name passed!");if(this.passphrase&&!this.symKey)throw new Error("Call getEncryptionSettings() first!");const s=yield this.request("GET",`/cache/${this.class}/${this.id}/${t}`),r=null==s?void 0:s.value;if(!r)return;const n=yield this.getSymKeyForKeyVersion(s.keyVersion),o=n?JSON.parse(yield i.decrypt(n,r)):r;return(null==s?void 0:s.keyVersion)>-1&&s.keyVersion!==(null===(e=this.encryptionSettings)||void 0===e?void 0:e.keyVersion)&&this.logger.log("warn",`Item "${t}" has an old encryption and can be updated by storing it again.`),{value:o,expiresAt:s.expiresAt,keyVersion:s.keyVersion}}))}getItems(t){return e.__awaiter(this,void 0,void 0,(function*(){var e;if(!t||0===t.length)throw new Error("No names passed!");if(this.passphrase&&!this.symKey)throw new Error("Call getEncryptionSettings() first!");const s=yield this.request("POST",`/cache-query/${this.class}/${this.id}`,t);if(0===Object.keys(s).length)return;const r={};for(const t of Object.keys(s)){const n=s[t],o=null==n?void 0:n.value;if(!o)continue;const l=yield this.getSymKeyForKeyVersion(n.keyVersion),a=l?JSON.parse(yield i.decrypt(l,o)):o;(null==n?void 0:n.keyVersion)>-1&&n.keyVersion!==(null===(e=this.encryptionSettings)||void 0===e?void 0:e.keyVersion)&&this.logger.log("warn",`Item "${t}" has an old encryption and can be updated by storing it again.`),r[t]={value:a,expiresAt:n.expiresAt,keyVersion:n.keyVersion}}return r}))}getAllItems(t){return e.__awaiter(this,void 0,void 0,(function*(){var e;if(this.passphrase&&!this.symKey)throw new Error("Call getEncryptionSettings() first!");const s=yield this.request("GET",`/cache/${this.class}/${this.id}${(null==t?void 0:t.prefix)?`?prefix=${null==t?void 0:t.prefix}`:""}`);if(0===Object.keys(s).length)return;const r={};for(const t of Object.keys(s)){const n=s[t],o=null==n?void 0:n.value;if(!o)continue;const l=yield this.getSymKeyForKeyVersion(n.keyVersion),a=l?JSON.parse(yield i.decrypt(l,o)):o;r[t]={value:a,expiresAt:n.expiresAt,keyVersion:null!==(e=n.keyVersion)&&void 0!==e?e:void 0}}return r}))}getAllKeys(t){return e.__awaiter(this,void 0,void 0,(function*(){return yield this.request("GET",`/cache-keys/${this.class}/${this.id}${(null==t?void 0:t.prefix)?`?prefix=${null==t?void 0:t.prefix}`:""}`)}))}removeItem(t){return e.__awaiter(this,void 0,void 0,(function*(){if(!t)throw new Error("No name passed!");yield this.request("DELETE",`/cache/${this.class}/${this.id}/${t}`)}))}removeItems(t){return e.__awaiter(this,void 0,void 0,(function*(){if(!t||0===t.length)throw new Error("No names passed!");yield this.request("DELETE",`/cache/${this.class}/${this.id}`,t)}))}clear(){return e.__awaiter(this,void 0,void 0,(function*(){yield this.request("DELETE",`/cache/${this.class}/${this.id}`)}))}};
