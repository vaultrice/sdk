"use strict";var t=require("./_virtual/_tslib.js"),e=require("./local.js"),i=require("./encryption.js"),r=require("./uuidv4.js");class s{constructor(t,i=function(){return e.getLocalId()||("undefined"!=typeof crypto&&crypto.randomUUID?`${crypto.randomUUID()}-${crypto.randomUUID()}`:`${r()}-${r()}`)}(),s){if(this.id=i,!t||"object"!=typeof t||"string"!=typeof t.apiKey||"string"!=typeof t.apiSecret||"string"!=typeof t.projectId)throw new Error("Invalid credentials!");e.setLocalId(this.id),this.credentials=t,(null==s?void 0:s.passphrase)&&(this.passphrase=null==s?void 0:s.passphrase)}init(){return t.__awaiter(this,void 0,void 0,(function*(){if(!this.passphrase)throw new Error("No passphrase passed! This function is only allowed with e2e encryption!");const t=yield this.request("GET",`/cache-meta/${this.id}`);this.metadata={salt:Uint8Array.from(atob(null==t?void 0:t.salt),(t=>t.charCodeAt(0))),keyVersion:null==t?void 0:t.keyVersion},this.symKey=yield i.deriveSymmetricKey(this.passphrase,this.id,this.metadata.salt)}))}request(e,i,r,o){return t.__awaiter(this,void 0,void 0,(function*(){const t="string"==typeof r,a={Authorization:`Basic ${btoa(`${this.credentials.apiKey}:${this.credentials.apiSecret}`)}`};void 0!==o&&o>-1&&(a["X-Enc-KV"]=o.toString()),r&&(a["Content-Type"]=t?"text/plain":"application/json");const n=yield fetch(`${s.basePath}/project/${this.credentials.projectId}${i}`,{method:e,headers:a,body:t?r:JSON.stringify(r)}),d=n.headers.get("content-type");let p;if(d&&(0===d.indexOf("text/plain")?p=yield n.text():0===d.indexOf("application/json")&&(p=yield n.json())),!n.ok){if("string"==typeof p)throw new Error(p);if(p)throw new Error(p.message)}return p}))}}s.basePath="http://localhost:5173",module.exports=s;
